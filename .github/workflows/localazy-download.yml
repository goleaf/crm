name: Localazy Download

on:
  # Run on schedule (daily at 2 AM UTC)
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run when translations are updated in Localazy (webhook)
  repository_dispatch:
    types: [localazy-updated]

permissions:
  contents: write

jobs:
  download-translations:
    runs-on: ubuntu-latest
    name: Download Translations from Localazy

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download translations from Localazy
        if: ${{ secrets.LOCALAZY_READ_KEY != '' && secrets.LOCALAZY_WRITE_KEY != '' }}
        uses: localazy/download@v1
        with:
          read_key: ${{ secrets.LOCALAZY_READ_KEY }}
          write_key: ${{ secrets.LOCALAZY_WRITE_KEY }}

      - name: Skip Localazy download (missing secrets)
        if: ${{ secrets.LOCALAZY_READ_KEY == '' || secrets.LOCALAZY_WRITE_KEY == '' }}
        run: |
          echo "## âš ï¸ Localazy secrets missing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Set LOCALAZY_READ_KEY and LOCALAZY_WRITE_KEY to enable translation downloads." >> $GITHUB_STEP_SUMMARY

      - name: Check for changes
        id: check_changes
        if: ${{ secrets.LOCALAZY_READ_KEY != '' && secrets.LOCALAZY_WRITE_KEY != '' }}
        run: |
          if [[ -n $(git status --porcelain -- lang/) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add lang/
          git commit -m "chore: update translations from Localazy [skip ci]"
          git push

      - name: Create summary
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          echo "## ðŸŒ Translations Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Translations have been downloaded from Localazy and committed to the repository." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Files" >> $GITHUB_STEP_SUMMARY
          git diff --name-only HEAD~1 HEAD | grep "^lang/" >> $GITHUB_STEP_SUMMARY || echo "No language files changed" >> $GITHUB_STEP_SUMMARY

      - name: No changes summary
        if: steps.check_changes.outputs.changes == 'false'
        run: |
          echo "## âœ… No Translation Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All translations are up to date." >> $GITHUB_STEP_SUMMARY
